- name: Foreman installer (pre-run) 
  shell: foreman-installer --foreman-configure-scl-repo=false --enable-foreman-plugin-puppetdb

- name: Get OAuth Secret 
  shell: awk '/oauth_consumer_secret/{print $2}' /etc/foreman/settings.yaml
  register: consumer_secret

- name: Get OAuth Key
  shell: awk '/oauth_consumer_key/{print $2}' /etc/foreman/settings.yaml
  register: consumer_key

- name: Install Foreman
  command: foreman-installer --puppet-server-facts=true  --enable-foreman-proxy   --foreman-proxy-tftp=true   --foreman-proxy-tftp-servername={{ ops_ip }}  --foreman-proxy-dhcp=true  --foreman-proxy-dhcp-interface={{ ops_mgmt_interface }}   --foreman-proxy-dhcp-gateway={{ mgmt_gateway }}  --foreman-proxy-dhcp-range="{{ mgmt_dhcp_range }}"   --foreman-proxy-dhcp-nameservers="{{ ops_ip }}"   --foreman-proxy-dns=true   --foreman-proxy-dns-interface={{ ops_mgmt_interface }}  --foreman-proxy-dns-zone={{ zone }}.{{ domain }}   --foreman-proxy-dns-reverse={{ reverse_dns }}  --foreman-proxy-dns-forwarders={{ proxy_dns_forwarder }}  --foreman-proxy-foreman-base-url=https://ops1.{{ zone }}.{{ domain }}  --foreman-proxy-oauth-consumer-key={{ consumer_key.stdout }}  --foreman-proxy-oauth-consumer-secret={{ consumer_secret.stdout }} --puppet-server-environments {{ puppet_env }}

- name: Copy Global PXE Template
  copy: src=pxelinux_global.erb 
        dest=/tmp/pxelinux_global.erb
        mode=0644
        owner=root
        group=root
        
- name: Discover testing environments
  shell: /bin/hammer environment info --name testing
  register: test_env_exists
  ignore_errors: True

- name: Discover development existing environments
  shell: /bin/hammer environment info --name develop
  register: dev_env_exists
  ignore_errors: True

- name: Create Testing environments
  command: /bin/hammer environment create --name testing
  when: test_env_exists|failed

- name: Create Development environment
  command: /bin/hammer environment create --name develop
  when: dev_env_exists| failed

- name: Create TFTPBoot Directory
  file: path=/var/lib/tftpboot/boot
        state=directory
        mode=0755
        owner=foreman-proxy
        group=root

- name: Fetch Discovery Installation Media
  get_url: url="{{ item.url }}"
           dest="{{ item.dest }}"
           sha256sum="{{ item.sha256sum }}"
  with_items:
    - {
        url: 'http://downloads.theforeman.org/discovery/releases/latest/foreman-discovery-image-latest.el6.iso-img',
        dest: '/var/lib/tftpboot/boot/discover-initrd.img',
        sha256sum: '6b8e64a97573cba17872d288344372ac3379eb866a4ccf00b6320a11b048d795'
      }
    - {
        url: 'http://downloads.theforeman.org/discovery/releases/latest/foreman-discovery-image-latest.el6.iso-vmlinuz',
        dest: '/var/lib/tftpboot/boot/discover-vmlinuz',
        sha256sum: '8d10b2174da46e05ddc1074e6450bd103c6dd571f3c1c8c43892c356e4d8e716'
      }
