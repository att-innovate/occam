- name: Install r10k
  gem: name=r10k state=present

- name: Register r10k path
  shell: gem contents r10k | grep bin
  register: r10k_path

- name: Deploy r10k Configuration
  template: src=r10k.yaml
            dest=/etc/r10k.yaml
            owner=root
            group=root
            mode=0644

- file: path=/root/bin state=directory owner=root group=root mode=0700
- file: src="{{ r10k_path.stdout }}" dest=/root/bin/r10k state=link

- name: Clear Out Old Environments
  shell: /bin/rm -rf /etc/puppet/environments/* creates=/etc/puppet/environments/testing

- name: Fetch Occam Modules And Environments
  command: "{{ r10k_path.stdout }} deploy environment -p"
