- name: Fix UTF8 in rack app
  lineinfile: dest=/etc/puppet/rack/config.ru line="Encoding.default_external = Encoding::UTF_8"
  notify:
    - restart httpd

- command: /usr/bin/puppet agent -t
  ignore_errors: yes

- name: Assign OPS to testing environment
  command: /bin/hammer host update --name ops1.{{ domain }} --environment testing

- name: Admin Password for Foreman
  command: /bin/awk '/admin_password/{print $2}' /etc/foreman/foreman-installer-answers.yaml
  register: foreman_password

# This probably needs to determine the proxy id, but for current env.s there's
# only one proxy
- name: Import Puppet Classes from Proxy
  command: /bin/curl -k --user 'admin:{{ foreman_password.stdout }}' -X POST https://ops1.{{ domain }}/api/smart_proxies/1/import_puppetclasses
  async: 600
  poll: 30

- debug: var=foreman_password.stdout
